<!DOCTYPE html>
<html lang="en">

<head>
  <!-- GENERAL: Setting up character encoding, viewport for responsive design, and linking the CSS stylesheet -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Resume Builder</title>
  <!-- Google Fonts: Roboto -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="../CSS/style.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>

<body>
  <!-- GENERAL: Main container for all page content -->
  <div class="container">
    <!-- HEADER: Contains the logo and navigation menu -->
    <header class="header">
      <!-- Logo section -->
      <div class="logo-container">
        <img src="../LogoNN.jpg" alt="Resume Builder Logo" class="logo" />
      </div>
      <!-- Navigation bar with links to different pages -->
      <nav class="navigation">
        <ul class="nav-list">
          <!-- HOME PAGE LINK: Navigates to Home section -->
          <li class="nav-item">
            <a href="#" class="nav-link" onclick="navigateTo('home'); return false;">Home</a>
          </li>
          <!-- BUILD RESUME PAGE LINK: Navigates to Build Resume section -->
          <li class="nav-item">
            <a href="#" class="nav-link" onclick="navigateTo('buildResume'); return false;">Build Resume</a>
          </li>
          <!-- LOGIN PAGE LINK: Navigates to Log In section -->
          <li class="nav-item" id="loginNavItem">
            <a href="#" class="nav-link" onclick="navigateTo('logIn'); return false;">Log In</a>
          </li>
          <li class="nav-item user-info" style="display: none;" id="userInfoNavItem">
            <span id="userEmail" class="user-email"></span> <!-- Display user email here -->
            <button id="signOutButton" class="btn sign-out-btn">Sign Out</button>


          </li>
        </ul>
      </nav>
    </header>

    <!-- HOME PAGE SECTION: Visible when users first visit the site -->
    <main id="home" class="page-section">
      <!-- HERO SECTION: Contains welcome message and a call-to-action button -->
      <section class="hero">
        <h1 class="hero-title">Build Your Professional Resume</h1>
        <p class="hero-description">
          Join thousands of others who have created their resumes easily with
          our tool.
        </p>
        <!-- Button to navigate to the Build Resume section -->
        <button id="get-started" class="btn cta" onclick="navigateTo('buildResume'); return false;">
          Get Started
        </button>
      </section>
      <!-- FEATURES: Highlighting the features or additional information -->
      <section id="create" class="feature">
        <h2 class="feature-title">Build Resume</h2>
        <p class="feature-description">
          Start building your professional resume quickly and easily with our
          step-by-step guide.
        </p>
      </section>
      <section id="templates" class="feature">
        <h2 class="feature-title">Browse Our Templates</h2>
        <p class="feature-description">
          Choose from a variety of customizable, professional templates.
        </p>
      </section>
    </main>

    <!-- BUILD RESUME SECTION: Contains form for building the resume, hidden by default -->
    <main id="buildResume" class="page-section" style="display: none">
      <section class="hero">
        <h1 class="hero-title">Build Your Professional Resume</h1>
        <p class="hero-description">
          Customize and download your professional resume in minutes.
        </p>
      </section>
      <!-- RESUME BUILDER FORM: Form for users to input their resume details -->
      <section class="resume-builder">
        <form class="resume-form" id="resume-form">
          <!-- PERSONAL INFORMATION: Section for user's personal details -->
          <fieldset>
            <legend>Personal Information</legend>

            <label for="full-name">Full Name:</label>
            <input type="text" id="full-name" name="full-name" required
              onchange="updateCVPreview(getCurrentTemplateName())" />

            <label for="job-title">Job Title:</label>
            <input type="text" id="job-title" name="job-title" required
              onchange="updateCVPreview(getCurrentTemplateName())" />

            <label for="email">Email:</label>
            <input type="email" id="email" name="email" required onchange="updateCVPreview(getCurrentTemplateName())" />

            <label for="phone">Phone:</label>
            <input type="tel" id="phone" name="phone" required onchange="updateCVPreview(getCurrentTemplateName())" />

            <label for="linkedin">LinkedIn:</label>
            <input type="url" id="linkedin" name="linkedin" placeholder="Optional - LinkedIn Profile URL"
              onchange="updateCVPreview(getCurrentTemplateName())" />



            <label for="personal-summary">Personal Summary:</label>
            <textarea id="personal-summary" name="personal-summary" required
              onchange="updateCVPreview(getCurrentTemplateName())"></textarea>
          </fieldset>

          <!-- CV PHOTO: Section for uploading a CV photo -->
          <fieldset>
            <legend>CV Photo</legend>
            <input type="file" id="cv-photo" name="cv-photo" accept="image/*" />
            <button type="button" id="upload-photo" class="btn">
              Upload Photo
            </button>
          </fieldset>
          <!-- WORK EXPERIENCE: Section for adding work experience details -->
          <fieldset>
            <legend>Work Experience</legend>
            <div id="work-experience-section">
              <!-- Placeholder for dynamically adding work experience fields -->
            </div>
            <button type="button" id="add-experience" class="btn">
              Add Experience
            </button>
          </fieldset>
          <!-- EDUCATION: Section for adding educational details -->
          <fieldset>
            <legend>Education</legend>
            <div id="education-section">
              <!-- Placeholder for dynamically adding education fields -->
            </div>
            <button type="button" id="add-education" class="btn">
              Add Education
            </button>
          </fieldset>
          <!-- TEMPLATE SELECTION: Options to choose a resume template -->
          <div class="template-selection-container">
            <button type="button" class="btn template-btn" onclick="selectTemplate('modern')">Modern Template</button>
            <button type="button" class="btn template-btn" onclick="selectTemplate('minimalistic')">Minimalistic
              Template</button>
          </div>

          <!-- Modern Template Preview -->
          <!-- Photo is positioned at the top left of the Modern Template -->
          <div id="modern-template-preview" class="resume-template modern" style="display: none">
            <img id="cv-photo-modern" src="path-to-default-photo.jpg" alt="Profile Photo" style="float: left;" />
            <div class="modern-header">
              <h1>Karla Santos</h1>
              <h2>Senior Front End Developer</h2>
            </div>
            <div class="modern-contact-info">
              <ul>
                <li>Email: karlasantos@example.com</li>
                <li>Phone: 0769828333</li>
                <li>LinkedIn: <a href="https://www.linkedin.com/in/" target="_blank"></a></li>
              </ul>
            </div>
            <div class="modern-career-objective">
              <p>
                As a front-end developer with a passion for beautiful, functional design...
              </p>
            </div>
            <!-- Work Experience Section -->
            <div class="modern-experience">
              <h3>Experience</h3>
              <ul id="modern-experience-list">
                <!-- Dynamically generated experiences will be inserted here -->
              </ul>
            </div>
            <!-- Education Section -->
            <div class="modern-education">
              <h3>Education</h3>
              <ul id="modern-education-list">
                <!-- Dynamically generated education entries will be inserted here -->
              </ul>
            </div>
          </div>

          <!-- Minimalistic Template Preview -->
          <div id="minimalistic-template-preview" class="resume-template minimalistic" style="display: none">
            <div class="minimalistic-header">
              <img id="cv-photo-minimalistic" src="path-to-default-photo.jpg" alt="Profile Photo" />
              <h1>Karla Santos</h1>
              <h2>Director of Product Management</h2>
            </div>
            <div class="minimalistic-contact-info">
              <ul>
                <li>Email: karlasantos@example.com</li>
                <li>Phone: 0769828333</li>
                <li>LinkedIn: <a href="https://www.linkedin.com/in/" target="_blank"></a></li>
              </ul>
              <div class="minimalistic-summary">
                <p id="minimalistic-personal-summary">
                  Your personal summary will appear here.
                </p>
              </div>
            </div>
            <!-- Work Experience Section -->
            <div class="minimalistic-experience">
              <h3>Experience</h3>
              <ul id="minimalistic-experience-list">
                <!-- Dynamically generated experiences will be inserted here -->
              </ul>
            </div>
            <!-- Education Section -->
            <div class="minimalistic-education">
              <h3>Education</h3>
              <ul id="minimalistic-education-list">
                <!-- Dynamically generated education entries will be inserted here -->
              </ul>
            </div>
          </div>

          <div id="cv-preview" class="cv-preview">
            <!-- Dynamically generated CV will be displayed here -->
          </div>

          <div class="submit-button-container">
            <button type="submit" class="btn cta">
              Download Resume As PDF File
            </button>
            <!-- Print Button -->
            <button type="button" id="print-resume" class="btn cta">
              Print Resume
              <!-- Save CV Button -->
              <button type="button" id="save-cv" class="btn cta">
                Save CV
              </button></button>
            <!-- Load CV Button -->
            <button type="button" class="btn load-cv-btn">Load CV</button>
            <select id="cv-selection-dropdown" style="display: none;"></select>


          </div>
        </form>
      </section>
    </main>

    <!-- LOGIN SECTION: Contains form for logging in, hidden by default -->
    <main id="logIn" class="page-section" style="display: none">
      <section class="login-container">
        <h1 class="login-title">Log In to Your Account</h1>
        <!-- Add id="login-form" to the form element -->
        <form class="login-form" id="login-form">
          <label for="login-email">Email:</label>
          <input type="email" id="login-email" name="login-email" required />
          <label for="login-password">Password:</label>
          <input type="password" id="login-password" name="login-password" required />
          <button type="submit" class="btn">Log In</button>
        </form>
        <!-- REGISTRATION PROMPT: Link to navigate to the registration section -->
        <p class="register-prompt">
          Don't have an account?
          <a href="#" class="nav-link" onclick="navigateTo('register'); return false;">Register here</a>
        </p>
      </section>
    </main>

    <!-- REGISTRATION SECTION: Contains form for registering a new account, hidden by default -->
    <main id="register" class="page-section" style="display: none">
      <section class="login-container">
        <h1 class="login-title">Register for an Account</h1>
        <form class="login-form" id="registration-form">
          <label for="register-email">Email:</label>
          <input type="email" id="register-email" name="register-email" required />

          <label for="register-password">Password:</label>
          <input type="password" id="register-password" name="register-password" required />

          <label for="confirm-password">Confirm Password:</label>
          <input type="password" id="confirm-password" name="confirm-password" required />

          <button type="submit" class="btn">Register</button>
          <!-- LOGIN PROMPT: Link to navigate to the login section -->
          <p class="register-prompt">
            Already have an account?
            <a href="#" class="nav-link" onclick="navigateTo('logIn'); return false;">Log in here</a>
          </p>
        </form>
      </section>
    </main>

    <!-- FOOTER: Footer of the website with copyright notice -->
    <footer class="footer">
      <p>Â© 2024 CareerCanvas COMP1004 Project. All rights reserved.</p>
    </footer>
  </div>
  <!-- Firebase SDK -->



  <script type="module">
    // Firebase SDK inclusion and initialization
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-auth.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-storage.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-auth.js";
    import { signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-auth.js";
    import { setDoc, addDoc, getDoc, doc, query, collection, where, orderBy, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js";


    const firebaseConfig = {
      apiKey: "AIzaSyCOLRzioTQibxjYYWvDEUC_T1m-ZsUEYWs",
      authDomain: "careercanvas---comp1004.firebaseapp.com",
      projectId: "careercanvas---comp1004",
      storageBucket: "careercanvas---comp1004.appspot.com",
      messagingSenderId: "919468929826",
      appId: "1:919468929826:web:412ee0fa37278c5d2cab7b",
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);
    const auth = getAuth(app);
    const db = getFirestore(app);

    document.addEventListener("DOMContentLoaded", () => {
      handleLoginFormSubmission(); // Attach the login form event listener
      setupFirebaseStorage(); // Set up Firebase storage
      fetchAndPopulateCV(); // Fetch the user's CV data and populate the form
      fetchAndDisplayUserCVs(); // Fetch and display the user's saved CVs
    });

    // Event listener for the Load CV button
    document.querySelector('.load-cv-btn').addEventListener('click', async () => {
      const cvDropdown = document.getElementById('cv-selection-dropdown');
      cvDropdown.innerHTML = ''; // Clear previous options
      cvDropdown.style.display = 'inline'; // Show the dropdown

      // Call a function to fetch CVs and populate the dropdown
      await fetchAndDisplayUserCVs();
    });


    async function fetchAndDisplayUserCVs() {
      // Assuming you're logged in...
      const user = auth.currentUser;
      if (!user) {
        console.error("Not logged in");
        return;
      }

      const cvDropdown = document.getElementById('cv-selection-dropdown');
      const cvsQuery = query(collection(db, "cvs"), where("uid", "==", user.uid), orderBy("timestamp", "desc"));

      const querySnapshot = await getDocs(cvsQuery);
      querySnapshot.forEach(doc => {
        const option = document.createElement('option');
        option.value = doc.id;
        option.textContent = `CV saved on ${new Date(doc.data().timestamp.seconds * 1000).toLocaleString()}`;
        cvDropdown.appendChild(option);
      });

      cvDropdown.onchange = async () => {
        const selectedCVId = cvDropdown.value;
        await loadSelectedCV(selectedCVId);
      };
    }


    async function loadSelectedCV(cvId) {
      // Get the CV document from Firestore
      const cvRef = doc(db, "cvs", cvId);
      const cvSnap = await getDoc(cvRef);

      if (cvSnap.exists()) {
        const cvData = cvSnap.data();

        // Populate static fields
        document.getElementById("full-name").value = cvData.fullName || "";
        document.getElementById("job-title").value = cvData.jobTitle || "";
        document.getElementById("email").value = cvData.email || "";
        document.getElementById("phone").value = cvData.phone || "";
        document.getElementById("linkedin").value = cvData.linkedin || "";
        document.getElementById("personal-summary").value = cvData.personalSummary || "";

        // Reset dynamic experiences and education fields before repopulating
        document.querySelectorAll(".experience-block").forEach(block => block.remove());
        document.querySelectorAll(".education-block").forEach(block => block.remove());


        // Handling timestamp separately
        if (cvData.timestamp) {
          // Format the timestamp to a readable string
          const dateSaved = cvData.timestamp.toDate().toLocaleString(); // Converts Firestore Timestamp to JavaScript Date, then to Locale String
          console.log("CV was saved on: ", dateSaved); // Log the date to the console


        }
      } else {
        console.log("No such CV!");
      }
      // Reset template selection
      document.querySelectorAll(".resume-template").forEach(template => {
        template.style.display = 'none';
      });
    }


    // Registration
    document.getElementById("registration-form").addEventListener("submit", async (event) => {
      event.preventDefault();

      const email = document.getElementById("register-email").value;
      const password = document.getElementById("register-password").value;
      const confirmPassword = document.getElementById("confirm-password").value;

      if (password !== confirmPassword) {
        alert("Passwords do not match.");
        return;
      }

      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        console.log("User registered: ", userCredential.user);

        // Perform sign out in the background
        await auth.signOut();

        // Inform the user of successful registration
        alert("Registration successful. Redirecting to login page.");

        // Implement a slight delay before redirection to allow sign out to complete
        setTimeout(() => navigateTo('logIn'), 500);

      } catch (error) {
        console.error("Registration error: ", error);
        alert("Failed to register: " + error.message);
      }
    });



    // Listen for authentication state to change.
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // User is signed in, show the user's email and "Sign Out" button
        onLoginSuccess(user.email);
      } else {
        // User is signed out, show the "Log In" button
        document.getElementById('loginNavItem').style.display = 'block';
        document.getElementById('userInfoNavItem').style.display = 'none';
      }
    });
    function onLoginSuccess(userEmail) {
      const loginNavItem = document.getElementById("loginNavItem");
      const userInfoNavItem = document.getElementById("userInfoNavItem");

      if (loginNavItem && userInfoNavItem) {
        loginNavItem.style.display = "none"; // Hide the Log In button
        document.getElementById("userEmail").textContent = userEmail; // Set user's email
        userInfoNavItem.style.display = "block"; // Show user info and Sign Out button
      } else {
        console.error("Element(s) not found: Check IDs");
      }
    }

    // Sign out function
    function signOut() {
      auth
        .signOut()
        .then(() => {
          // On successful sign out
          alert("Signed out successfully");
          document.getElementById("loginNavItem").style.display = "block"; // Show the Log In button
          document.getElementById("userInfoNavItem").style.display = "none"; // Hide user info and Sign Out button
          navigateTo("home"); // Navigate to the home page or wherever you see fit
        })
        .catch((error) => {
          // Handle errors here
          console.error("Sign Out Error", error);
          alert("Failed to sign out. Please try again.");
        });
    }


    // Function to handle login form submission
    function handleLoginFormSubmission() {
      const loginForm = document.getElementById('login-form');
      if (loginForm) {
        loginForm.addEventListener('submit', function (event) {
          event.preventDefault(); // Prevent the form from submitting in the default way

          // Get user input from form
          const email = document.getElementById('login-email').value;
          const password = document.getElementById('login-password').value;

          // Sign in the user with Firebase Authentication
          signInWithEmailAndPassword(auth, email, password)
            .then((userCredential) => {
              console.log('User logged in:', userCredential.user);
              alert('Login successful! Redirecting to home page.'); // Inform user of successful login
              onLoginSuccess(userCredential.user.email); // Handle login success UI changes
              navigateTo('home'); // Navigate to the home page. Ensure this function is defined and works as expected
            })
            .catch((error) => {
              const errorCode = error.code;
              const errorMessage = error.message;
              console.error('Sign in error', errorCode, errorMessage);
              alert('Failed to log in: ' + errorMessage); // Show the user an error message
            });
        });
      }
    }

    async function fetchAndPopulateCV() {
      const auth = getAuth();
      const db = getFirestore();
      const user = auth.currentUser;

      if (user) {
        const cvRef = doc(db, "cvs", user.uid);
        const cvSnap = await getDoc(cvRef);

        if (cvSnap.exists()) {
          const formData = cvSnap.data();
          document.getElementById("full-name").value = formData.fullName || "";
          document.getElementById("job-title").value = formData.jobTitle || "";

        } else {
          console.log("No CV found!");
        }
      }
    }





    // Resize image before upload
    function resizeImage(file, maxWidth, maxHeight, callback) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          let width = img.width;
          let height = img.height;

          if (width > height) {
            if (width > maxWidth) {
              height *= maxWidth / width;
              width = maxWidth;
            }
          } else {
            if (height > maxHeight) {
              width *= maxHeight / height;
              height = maxHeight;
            }
          }

          const canvas = document.createElement("canvas");
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, width, height);

          canvas.toBlob((blob) => {
            callback(blob, canvas.toDataURL("image/png")); // Pass the data URLL 
          });
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    // SetupFirebaseStorage to include resize, feedback, and button text change
    function setupFirebaseStorage() {
      const uploadPhotoButton = document.getElementById("upload-photo");
      const cvPhotoInput = document.getElementById("cv-photo");


      async function saveCVToFirestore() {
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Fetch form data as before
        const formData = getFormData();

        // Add a timestamp to the formData object
        formData.timestamp = serverTimestamp(); // Firestore server timestamp
        const user = auth.currentUser;
        if (!user) {
          alert("You need to be logged in to save your CV.");
          return;
        }

        try {
          // 
          await addDoc(collection(db, "cvs"), {
            ...formData,
            uid: user.uid
          });
          alert("CV saved successfully.");
        } catch (error) {
          console.error("Error saving CV:", error);
          alert("Failed to save CV. Please try again.");
        }
      }






      const saveCVButton = document.getElementById("save-cv");
      if (saveCVButton) {
        saveCVButton.addEventListener("click", async () => {
          await saveCVToFirestore();
        });
      } else {
        console.error("Save CV button not found");
      }

      const signOutButton = document.getElementById("signOutButton");
      if (signOutButton) {
        signOutButton.addEventListener("click", signOut);
      }





      uploadPhotoButton.addEventListener("click", async () => {
        if (cvPhotoInput.files.length > 0) {
          const file = cvPhotoInput.files[0];

          // Resize image
          resizeImage(file, 197, 197, async (blob, dataUrl) => { // 5cm x 5cm 
            const storageRef = ref(storage, `photo_upload/${file.name}`);

            try {
              const uploadTaskSnapshot = await uploadBytes(storageRef, blob);
              const downloadURL = await getDownloadURL(uploadTaskSnapshot.ref);

              console.log("File available at", downloadURL);
              // Use the data URL for the image src to avoid CORS issues with canvas
              document.getElementById("cv-photo-modern").src = dataUrl;
              document.getElementById("cv-photo-minimalistic").src = dataUrl;

              // Feedback to user
              alert("Photo uploaded successfully!");

              // Change button text
              uploadPhotoButton.textContent = "Replace Photo";
            } catch (error) {
              console.error("Upload error:", error);
              alert("Failed to upload photo.");
            }
          });
        } else {
          console.error("No file selected for upload.");
          alert("Please select a file to upload.");
        }
      });
    }





  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.2/html2canvas.min.js"></script>
  <script src="../javascript.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>


</body>

</html>