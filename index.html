<!DOCTYPE html>
<html lang="en">

<head>
  <!-- GENERAL: Setting up character encoding, viewport for responsive design, and linking the CSS stylesheet -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Resume Builder</title>
  <!-- Google Fonts: Roboto -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="./style.css" />
  <!-- flatpickr Library: CSS for the date picker component -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
</head>

<body>
  <!-- GENERAL: Main container for all page content -->
  <div class="container">
    <!-- HEADER: Contains the logo and navigation menu -->
    <header class="header">
      <!-- Logo section -->
      <div class="logo-container">
        <img src="./Logo.jpg" alt="Resume Builder Logo" class="logo" />
      </div>
      <!-- Navigation bar with links to different pages -->
      <nav class="navigation">
        <ul class="nav-list">
          <!-- HOME PAGE LINK: Navigates to Home section -->
          <li class="nav-item">
            <a href="#" class="nav-link" onclick="navigateTo('home'); return false;">Home</a>
          </li>
          <!-- BUILD RESUME PAGE LINK: Navigates to Build Resume section -->
          <li class="nav-item">
            <a href="#" class="nav-link" onclick="navigateTo('buildResume'); return false;">Build Resume</a>
          </li>
          <!-- LOGIN PAGE LINK: Navigates to Log In section -->
          <li class="nav-item" id="loginNavItem">
            <a href="#" class="nav-link" onclick="navigateTo('logIn'); return false;">Log In</a>
          </li>
          <li class="nav-item user-info" style="display: flex; align-items: center" id="userInfoNavItem">
            <!-- Display user email here -->
            <span id="userEmail" class="user-email"></span>
            <!-- Button to load user's CV -->
            <button type="button" class="btn load-cv-btn">Load CV</button>
            <!-- Button to reset fields in the resume builder -->
            <button id="reset-cv-btn" class="btn sign-out-btn">
              Reset Fields
            </button>
            <!-- Button for user sign out -->
            <button id="signOutButton" class="btn sign-out-btn">
              Sign Out
            </button>
          </li>
        </ul>
      </nav>
    </header>

    <!-- HOME PAGE SECTION: Visible when users first visit the site -->
    <main id="home" class="page-section">
      <!-- HERO SECTION: Contains welcome message and a call-to-action button -->
      <section class="hero">
        <h1 class="hero-title">Build Your Professional Resume</h1>
        <p class="hero-description">
          Join thousands of others who have created their resumes easily with
          our tool.
        </p>
        <!-- Button to navigate to the Build Resume section -->
        <button id="get-started" class="btn cta" onclick="navigateTo('buildResume'); return false;">
          Get Started
        </button>
      </section>
      <!-- FEATURES: Highlighting the features or additional information -->
      <section id="create" class="feature">
        <h2 class="feature-title">Build Resume</h2>
        <p class="feature-description">
          Start building your professional resume quickly and easily with our
          step-by-step guide.
        </p>
      </section>
      <section id="templates" class="feature">
        <h2 class="feature-title">Browse Our Templates</h2>
        <p class="feature-description">
          Choose from a variety of customizable, professional templates.
        </p>
      </section>
    </main>

    <!-- BUILD RESUME SECTION: Contains form for building the resume, hidden by default -->
    <main id="buildResume" class="page-section" style="display: none">
      <section class="hero">
        <h1 class="hero-title">Build Your Professional Resume</h1>
        <p class="hero-description">
          Customize and download your professional resume in minutes.
        </p>
      </section>
      <!-- RESUME BUILDER FORM: Form for users to input their resume details -->
      <section class="resume-builder">
        <form class="resume-form" id="resume-form">
          <!-- PERSONAL INFORMATION: Section for user's personal details -->
          <fieldset>
            <legend>Personal Information</legend>

            <label for="full-name">Full Name:</label>
            <input type="text" id="full-name" name="full-name" required
              onchange="updateCVPreview(getCurrentTemplateName())" />

            <label for="job-title">Job Title:</label>
            <input type="text" id="job-title" name="job-title" required
              onchange="updateCVPreview(getCurrentTemplateName())" />

            <label for="email">Email:</label>
            <input type="email" id="email" name="email" required onchange="updateCVPreview(getCurrentTemplateName())" />

            <label for="phone">Phone:</label>
            <input type="tel" id="phone" name="phone" required onchange="updateCVPreview(getCurrentTemplateName())" />

            <label for="linkedin">LinkedIn:</label>
            <input type="url" id="linkedin" name="linkedin" placeholder="Optional - LinkedIn Profile URL"
              onchange="updateCVPreview(getCurrentTemplateName())" />

            <label for="personal-summary">Personal Summary:</label>
            <textarea id="personal-summary" name="personal-summary" required
              onchange="updateCVPreview(getCurrentTemplateName())"></textarea>
          </fieldset>

          <!-- CV PHOTO: Section for uploading a CV photo -->
          <fieldset>
            <legend>CV Photo</legend>
            <input type="file" id="cv-photo" name="cv-photo" accept="image/*" />
            <button type="button" id="upload-photo" class="btn">
              Upload Photo
            </button>
            <button type="button" id="remove-photo" class="btn">
              Remove Photo
            </button>
          </fieldset>
          <!-- WORK EXPERIENCE: Section for adding work experience details -->
          <fieldset>
            <legend>Work Experience</legend>
            <div id="work-experience-section">
              <!-- Placeholder for dynamically adding work experience fields -->
            </div>
            <button type="button" id="add-experience" class="btn">
              Add Experience
            </button>
          </fieldset>
          <!-- EDUCATION: Section for adding educational details -->
          <fieldset>
            <legend>Education</legend>
            <div id="education-section">
              <!-- Placeholder for dynamically adding education fields -->
            </div>
            <button type="button" id="add-education" class="btn">
              Add Education
            </button>
          </fieldset>
          <!-- TEMPLATE SELECTION: Options to choose a resume template -->
          <div class="template-selection-container">
            <button type="button" class="btn template-btn" onclick="selectTemplate('modern')">
              Modern Template
            </button>
            <button type="button" class="btn template-btn" onclick="selectTemplate('minimalistic')">
              Minimalistic Template
            </button>
            <button type="button" class="btn template-btn" onclick="selectTemplate('professional')">
              Professional Template
            </button>
          </div>

          <!-- Modern Template Preview -->
          <!-- Photo is positioned at the top left of the Modern Template -->
          <div id="modern-template-preview" class="resume-template modern" style="display: none">
            <img id="cv-photo-modern" src="path-to-default-photo.jpg" alt="Profile Photo" style="float: left" />
            <div class="modern-header">
              <h1>Karla Santos</h1>
              <h2>Senior Front End Developer</h2>
            </div>
            <div class="modern-contact-info">
              <ul>
                <li>Email: karlasantos@example.com</li>
                <li>Phone: 0769828333</li>
                <li>
                  LinkedIn:
                  <a href="https://www.linkedin.com/in/" target="_blank"></a>
                </li>
              </ul>
            </div>
            <div class="modern-career-objective">
              <p>
                As a front-end developer with a passion for beautiful,
                functional design...
              </p>
            </div>
            <!-- Work Experience Section -->
            <div class="modern-experience">
              <h3>Experience</h3>
              <ul id="modern-experience-list"></ul>
            </div>
            <!-- Education Section -->
            <div class="modern-education">
              <h3>Education</h3>
              <ul id="modern-education-list"></ul>
            </div>
          </div>

          <!-- Minimalistic Template Preview -->
          <div id="minimalistic-template-preview" class="resume-template minimalistic" style="display: none">
            <div class="minimalistic-header">
              <img id="cv-photo-minimalistic" src="path-to-default-photo.jpg" alt="Profile Photo" />
              <h1>Karla Santos</h1>
              <h2>Director of Product Management</h2>
            </div>
            <div class="minimalistic-contact-info">
              <ul>
                <li>Email: karlasantos@example.com</li>
                <li>Phone: 0769828333</li>
                <li>
                  LinkedIn:
                  <a href="https://www.linkedin.com/in/" target="_blank"></a>
                </li>
              </ul>
              <div class="minimalistic-summary">
                <p id="minimalistic-personal-summary">
                  Your personal summary will appear here.
                </p>
              </div>
            </div>
            <!-- Work Experience Section -->
            <div class="minimalistic-experience">
              <h3>Experience</h3>
              <ul id="minimalistic-experience-list"></ul>
            </div>
            <!-- Education Section -->
            <div class="minimalistic-education">
              <h3>Education</h3>
              <ul id="minimalistic-education-list"></ul>
            </div>
          </div>

          <div id="cv-preview" class="cv-preview"></div>

          <div id="professional-template-preview" class="resume-template professional" style="display: none">
            <!-- Professional Template Photo -->
            <div class="professional-photo">
              <img id="cv-photo-professional" src="path-to-default-photo.jpg" alt="Profile Photo" />
            </div>
            <div class="professional-header">
              <h1 id="cv-name-professional">Full Name</h1>
              <h2 id="cv-title-professional">Job Title</h2>
            </div>
            <div class="professional-contact-info">
              <ul>
                <li>Email: <span id="cv-email-professional"></span></li>
                <li>Phone: <span id="cv-phone-professional"></span></li>
                <li>
                  LinkedIn:
                  <a href="#" id="cv-linkedin-professional" target="_blank"></a>
                </li>
              </ul>
            </div>
            <div class="professional-summary">
              <p id="cv-summary-professional">Personal summary...</p>
            </div>
            <!-- Experience Section -->
            <div class="professional-experience">
              <h3>Experience</h3>
              <ul id="professional-experience-list"></ul>
            </div>
            <!-- Education Section -->
            <div class="professional-education">
              <h3>Education</h3>
              <ul id="professional-education-list"></ul>
            </div>
          </div>

          <div class="submit-button-container">
            <button type="submit" class="btn cta">
              Download Resume As PDF File
            </button>
            <!-- Print Button -->
            <button type="button" id="print-resume" class="btn cta">
              Print Resume
              <!-- Save CV Button -->
              <button type="button" id="save-cv" class="btn cta save-cv-btn">
                Save CV
              </button>
            </button>

            <div id="cvModal" class="modal">
              <div class="modal-content">
                <span class="close">&times;</span>
                <h2>Select a Resume</h2>
                <ul id="cvList" class="cv-list"></ul>
              </div>
            </div>
          </div>
        </form>
      </section>
    </main>

    <main id="logIn" class="page-section" style="display: none">
      <section class="login-container">
        <h1 class="login-title">Log In to Your Account</h1>
        <!-- Add id="login-form" to the form element -->
        <form class="login-form" id="login-form">
          <label for="login-email">Email:</label>
          <input type="email" id="login-email" name="login-email" required />
          <label for="login-password">Password:</label>
          <input type="password" id="login-password" name="login-password" required />
          <button type="submit" class="btn">Log In</button>
        </form>
        <!-- REGISTRATION PROMPT: Link to navigate to the registration section -->
        <p class="register-prompt">
          Don't have an account?
          <a href="#" class="nav-link" onclick="navigateTo('register'); return false;">Register here</a>
        </p>
      </section>
    </main>

    <!-- REGISTRATION SECTION: Contains form for registering a new account, hidden by default -->
    <main id="register" class="page-section" style="display: none">
      <section class="login-container">
        <h1 class="login-title">Register for an Account</h1>
        <form class="login-form" id="registration-form">
          <label for="register-email">Email:</label>
          <input type="email" id="register-email" name="register-email" required />

          <label for="register-password">Password:</label>
          <input type="password" id="register-password" name="register-password" required />

          <label for="confirm-password">Confirm Password:</label>
          <input type="password" id="confirm-password" name="confirm-password" required />

          <button type="submit" class="btn">Register</button>
          <!-- LOGIN PROMPT: Link to navigate to the login section -->
          <p class="register-prompt">
            Already have an account?
            <a href="#" class="nav-link" onclick="navigateTo('logIn'); return false;">Log in here</a>
          </p>
        </form>
      </section>
    </main>

    <!-- FOOTER: Footer of the website with copyright notice -->
    <footer class="footer">
      <p>Â© 2024 CareerCanvas COMP1004 Project. All rights reserved.</p>
    </footer>
  </div>
  <!-- Firebase SDK -->

  <script type="module">
    // Firebase SDK inclusion and initialization
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
    } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-auth.js";
    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL,
    } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-storage.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-auth.js";
    import { signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-auth.js";
    import {
      setDoc,
      addDoc,
      getDoc,
      doc,
      query,
      collection,
      where,
      orderBy,
      getDocs,
      deleteDoc,
      serverTimestamp,
    } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCOLRzioTQibxjYYWvDEUC_T1m-ZsUEYWs",
      authDomain: "careercanvas---comp1004.firebaseapp.com",
      projectId: "careercanvas---comp1004",
      storageBucket: "careercanvas---comp1004.appspot.com",
      messagingSenderId: "919468929826",
      appId: "1:919468929826:web:412ee0fa37278c5d2cab7b",
    };

    document.addEventListener("DOMContentLoaded", () => {
      // DOM is fully loaded before attaching event listeners and initializing Firebase
      console.log("DOM fully loaded and parsed");

      // Setup event listeners and Firebase integrations
      handleLoginFormSubmission(); // Manage login form submissions
      setupFirebaseStorage(); // Initialize Firebase storage for file uploads
      fetchAndDisplayUserCVs(); // Retrieve and display user CVs if logged in

      // Attach the event listener to the reset button
      document
        .getElementById("reset-cv-btn")
        .addEventListener("click", function () {
          resetBuildResumePage();
          console.log("Reset action performed");
        });

      // Modal for CV selection setup
      var modal = document.getElementById("cvModal");
      var loadCVBtn = document.querySelector(".load-cv-btn");
      var span = document.getElementsByClassName("close")[0]; // The close button for the modal

      // Ensure that modal visibility is explicitly handled
      loadCVBtn.onclick = function () {
        console.log("Load CV Button Clicked");
        modal.style.display = "block"; // Explicitly set display to "block"
        fetchAndDisplayUserCVs(); // Refresh CV list
      };

      // Close modal logic
      span.onclick = function () {
        modal.style.display = "none"; // Hide the modal on close button click
      };

      window.onclick = function (event) {
        if (event.target === modal) {
          modal.style.display = "none"; // Hide modal if clicked outside of it
        }
      };
    });
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);
    const auth = getAuth(app);
    const db = getFirestore(app);

    function resetBuildResumePage() {
      // Clear input fields
      document
        .querySelectorAll(
          'input[type="text"], input[type="email"], input[type="tel"], input[type="url"], textarea'
        )
        .forEach((input) => (input.value = ""));

      // Reset template selection to default
      document
        .querySelectorAll(".resume-template")
        .forEach((template) => (template.style.display = "none"));
      // Reset the photos to a default image or hide them
      const defaultPhoto = "path-to-default-photo.jpg"; // Replace this with the path to your default photo
      document.getElementById("cv-photo-modern").src = defaultPhoto;
      document.getElementById("cv-photo-minimalistic").src = defaultPhoto;
      document.getElementById("cv-photo-professional").src = defaultPhoto;

      // Clear dynamic sections and reset counters
      document.getElementById("work-experience-section").innerHTML = "";
      document.getElementById("education-section").innerHTML = "";
      experienceCount = 0;
      educationCount = 0;

      // Reset specific fields like LinkedIn if not covered by the generic query selector
      document.getElementById("linkedin").value = "";

      // Change the text of the photo upload button back to "Upload Photo"
      document.getElementById("upload-photo").textContent = "Upload Photo";

      // Refresh or reset the CV preview
      updateCVPreview();

      console.log("Page has been reset.");
    }

    // Function to load a selected CV from Firestore based on its ID
    async function loadSelectedCV(cvId) {
      // Create a reference to the specific CV document in the 'cvs' collection
      const cvRef = doc(db, "cvs", cvId);
      // Attempt to fetch the CV document from Firestore
      const cvSnap = await getDoc(cvRef);

      // Check if the CV document exists in Firestore
      if (cvSnap.exists()) {
        const cvData = cvSnap.data(); // Extract CV data
        populateFieldsWithData(cvData); // Populate the UI with CV data
      } else {
        // Log an error if the CV document doesn't exist
        console.log("No such CV!");
      }
    }

    // Function to fetch and display all CVs associated with the current user
    async function fetchAndDisplayUserCVs() {
      console.log("fetchAndDisplayUserCVs() called"); // Debugging log to indicate function call

      // Ensure there's a currently authenticated user
      const user = auth.currentUser;
      if (!user) {
        console.error("Not logged in"); // Log an error if no user is logged in
        return;
      }

      // Log fetching action with user's unique identifier (UID)
      console.log("Fetching CVs for user:", user.uid);

      // Reference to the HTML element where CVs will be listed
      const cvListElement = document.getElementById("cvList");
      cvListElement.innerHTML = ""; // Clear the list before adding new CV entries

      // Query Firestore for CVs that belong to the current user, ordered by timestamp
      const cvsQuery = query(
        collection(db, "cvs"),
        where("uid", "==", user.uid),
        orderBy("timestamp", "desc")
      );

      // Execute the query and receive a snapshot of the query results
      const querySnapshot = await getDocs(cvsQuery);

      // Log the count of fetched CVs for debugging
      console.log("CVs fetched:", querySnapshot.docs.length);

      // Process each CV document in the query snapshot
      querySnapshot.forEach((doc) => {
        console.log("Processing CV:", doc.id); // Log the processing of each CV

        // Create a list item for each CV and set its content
        const listItem = document.createElement("li");
        listItem.textContent = `CV saved on ${new Date(
          doc.data().timestamp.seconds * 1000
        ).toLocaleString()}`; // Format the timestamp for readability
        listItem.classList.add("cv-list-item"); // Apply styling class
        listItem.setAttribute("data-cv-id", doc.id); // Set a data attribute for the CV ID

        // Add a click event listener to load the selected CV
        listItem.onclick = async () => {
          await loadSelectedCV(doc.id); // Load the selected CV
          document.getElementById("cvModal").style.display = "none"; // Hide the modal after selection
        };

        // Create a delete button for each CV
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "Delete";
        deleteBtn.classList.add("delete-cv-btn"); // Add class for styling if needed
        deleteBtn.setAttribute("data-cv-id", doc.id); // Attach CV id to the button
        deleteBtn.setAttribute("type", "button"); // Set the button type to "button" to prevent it from submitting forms

        // Inline styles for the delete button
        deleteBtn.style.padding = "5px 10px";
        deleteBtn.style.fontSize = "12px";
        deleteBtn.style.marginLeft = "10px"; // Space from the CV text

        // Event listener for the delete button
        deleteBtn.addEventListener("click", (e) => {
          e.stopPropagation(); // Prevent the listItem's onclick from being triggered
          const confirmed = confirm(
            "Are you sure you want to delete this CV?"
          );
          if (confirmed) {
            const cvId = e.target.getAttribute("data-cv-id");
            deleteCV(cvId); // Call the delete function
          }
        });

        // Append delete button to the list item
        listItem.appendChild(deleteBtn);

        // Append the list item to the CV list in the UI
        cvListElement.appendChild(listItem);
      });
    }

    // Function to delete a specific CV from Firestore using its ID
    async function deleteCV(cvId) {
      try {
        await deleteDoc(doc(db, "cvs", cvId)); // Deletes the CV document from Firestore
        alert("CV deleted successfully."); // Notify user of successful deletion
        fetchAndDisplayUserCVs(); // Refresh the list of user's CVs displayed on the UI
      } catch (error) {
        console.error("Error deleting CV:", error); // Log any errors encountered during deletion
        alert("Failed to delete CV. Please try again."); // Notify user of failure to delete CV
      }
    }


    // Function that populates form fields with data from the selected CV
    function populateFieldsWithData(cvData) {
      // Directly populate static fields with CV data or fallback to an empty string
      document.getElementById("full-name").value = cvData.fullName || "";
      document.getElementById("job-title").value = cvData.jobTitle || "";
      document.getElementById("email").value = cvData.email || "";
      document.getElementById("phone").value = cvData.phone || "";
      document.getElementById("linkedin").value = cvData.linkedin || "";
      document.getElementById("personal-summary").value =
        cvData.personalSummary || "";

      // Clear existing dynamic experience and education entries before repopulating
      document
        .querySelectorAll(".experience-block")
        .forEach((block) => block.remove());
      document
        .querySelectorAll(".education-block")
        .forEach((block) => block.remove());

      // Reset counters for dynamically added fields
      experienceCount = 0;
      educationCount = 0;

      // Dynamically add experience and education fields based on CV data
      cvData.experiences.forEach((exp) => {
        experienceCount++;
        addExperienceField(exp); // Adds each experience entry to the form
      });
      cvData.educations.forEach((edu) => {
        educationCount++;
        addEducationField(edu); // Adds each education entry to the form
      });

      // Select the CV template if specified in the CV data
      if (cvData.templateName) {
        selectTemplate(cvData.templateName);
      }

      // Refresh the CV preview to reflect the newly loaded data
      updateCVPreview(getCurrentTemplateName());
    }

    // Event listener for the registration form submission
    document
      .getElementById("registration-form")
      .addEventListener("submit", async (event) => {
        event.preventDefault(); // Prevent the default form submission behavior

        // Extract form data
        const email = document.getElementById("register-email").value;
        const password = document.getElementById("register-password").value;
        const confirmPassword =
          document.getElementById("confirm-password").value;

        // Check if passwords match
        if (password !== confirmPassword) {
          alert("Passwords do not match.");
          return; // Exit if passwords don't match
        }

        // Attempt to register the user with Firebase Authentication
        try {
          const userCredential = await createUserWithEmailAndPassword(
            auth,
            email,
            password
          );
          console.log("User registered: ", userCredential.user); // Log the successful registration

          // Sign out the user after registration for redirect to login
          await auth.signOut();

          // Notify the user of successful registration and redirect
          alert("Registration successful. Redirecting to login page.");
          setTimeout(() => navigateTo("logIn"), 500); // Slight delay for UX before redirect
        } catch (error) {
          console.error("Registration error: ", error); // Log any registration errors
          alert("Failed to register: " + error.message); // Notify the user of the failure
        }
      });

    // Listen for changes in the authentication state (login/logout actions)
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // Executed when a user is signed in
        onLoginSuccess(user.email); // Custom function to handle UI changes on login

        // Reset form fields and images to prepare the UI for the logged-in user
        resetFormFieldsAndImages();
      } else {
        // Executed when the user signs out
        // Show the "Log In" button, hide user information
        document.getElementById("loginNavItem").style.display = "block";
        document.getElementById("userInfoNavItem").style.display = "none";

        // Clear form fields and reset images for a clean state
        resetFormFieldsAndImages();
      }
    });

    // Resets form fields and images to their default states
    function resetFormFieldsAndImages() {
      // Clear all text, email, tel, url input fields, and textareas
      document
        .querySelectorAll(
          'input[type="text"], input[type="email"], input[type="tel"], input[type="url"], textarea'
        )
        .forEach((input) => {
          input.value = ""; // Reset each field's value
        });

      // Reset the CV photo previews to the default image
      document.getElementById("cv-photo-modern").src =
        "path-to-default-photo.jpg";
      document.getElementById("cv-photo-minimalistic").src =
        "path-to-default-photo.jpg";
      document.getElementById("cv-photo-professional").src =
        "path-to-default-photo.jpg";

      // Clear dynamically added sections for work experience and education
      document.getElementById("work-experience-section").innerHTML = "";
      document.getElementById("education-section").innerHTML = "";

      // Clear the list of CVs, if it exists, inside the modal
      const cvListElement = document.getElementById("cvList");
      if (cvListElement) {
        cvListElement.innerHTML = ""; // Ensure a fresh start for the next user
      }
    }

    // Called when a user successfully logs in
    function onLoginSuccess(userEmail) {
      const loginNavItem = document.getElementById("loginNavItem");
      const userInfoNavItem = document.getElementById("userInfoNavItem");

      // Ensure elements exist before attempting to modify them
      if (loginNavItem && userInfoNavItem) {
        // Update UI to reflect user is logged in
        loginNavItem.style.display = "none"; // Hide the login option
        document.getElementById("userEmail").textContent = userEmail; // Display the user's email
        userInfoNavItem.style.display = "block"; // Show user info and sign-out button
      } else {
        // Log an error if expected elements are not found in the DOM
        console.error("Element(s) not found: Check IDs");
      }
    }

    // Signs out the current user
    function signOut() {
      auth
        .signOut()
        .then(() => {
          // Feedback and UI update upon successful sign out
          alert("Signed out successfully");
          document.getElementById("loginNavItem").style.display = "block"; // Reveal the login option
          document.getElementById("userInfoNavItem").style.display = "none"; // Hide user-specific options
          navigateTo("home"); // Redirect to the homepage
        })
        .catch((error) => {
          // Error handling for failed sign out attempt
          console.error("Sign Out Error", error);
          alert("Failed to sign out. Please try again.");
        });
    }

    // Sets up event listener for the login form submission
    function handleLoginFormSubmission() {
      const loginForm = document.getElementById("login-form");

      // Ensure the form exists before attaching the event listener
      if (loginForm) {
        loginForm.addEventListener("submit", function (event) {
          event.preventDefault(); // Prevent default form submission behavior

          // Collect user input from the form
          const email = document.getElementById("login-email").value;
          const password = document.getElementById("login-password").value;

          // Attempt to sign in the user with Firebase Authentication
          signInWithEmailAndPassword(auth, email, password)
            .then((userCredential) => {
              // On successful login, update the UI and navigate to the homepage
              console.log("User logged in:", userCredential.user);
              alert("Login successful! Redirecting to home page.");
              onLoginSuccess(userCredential.user.email); // Update UI to reflect user is logged in
              navigateTo("home"); // Go to the homepage
            })
            .catch((error) => {
              // Handle and display any sign-in errors
              console.error("Sign in error", error.code, error.message);
              alert("Failed to log in: " + error.message);
            });
        });
      }
    }

    // Function to resize an image before upload, ensuring it fits within specified maximum dimensions
    function resizeImage(file, maxWidth, maxHeight, callback) {
      const reader = new FileReader(); // Initialize a FileReader to read the image file

      // Event handler executed when FileReader has successfully read the file
      reader.onload = (e) => {
        const img = new Image(); // Create a new Image object

        // Event handler executed when the Image object has fully loaded the file data
        img.onload = () => {
          let width = img.width; // Original width of the image
          let height = img.height; // Original height of the image

          // Resize logic: adjust width and height while maintaining aspect ratio
          if (width > height) {
            // For wider images, adjust width to maxWidth if necessary
            if (width > maxWidth) {
              height *= maxWidth / width; // Adjust height to maintain aspect ratio
              width = maxWidth; // Adjust width to maxWidth
            }
          } else {
            // For taller images, adjust height to maxHeight if necessary
            if (height > maxHeight) {
              width *= maxHeight / height; // Adjust width to maintain aspect ratio
              height = maxHeight; // Adjust height to maxHeight
            }
          }

          // Use a canvas to apply the resizing
          const canvas = document.createElement("canvas");
          canvas.width = width; // Set canvas width to the new width
          canvas.height = height; // Set canvas height to the new height
          const ctx = canvas.getContext("2d"); // Get the canvas 2D context
          ctx.drawImage(img, 0, 0, width, height); // Draw the resized image on the canvas

          // Convert the canvas content to a Blob and execute the callback with the Blob and data URL of the image
          canvas.toBlob((blob) => {
            callback(blob, canvas.toDataURL("image/png")); // Execute callback with the resized image blob and its data URL
          });
        };
        img.src = e.target.result; // Set the source of the Image object to the file data
      };
      reader.readAsDataURL(file); // Start reading the file data
    }

    // Prepares the environment for user interactions with Firebase storage, specifically for uploading and handling CV photos and data
    function setupFirebaseStorage() {
      // Acquire references to the photo upload button and input field
      const uploadPhotoButton = document.getElementById("upload-photo");
      const cvPhotoInput = document.getElementById("cv-photo");

      // Defines a function to save CV data to Firestore
      async function saveCVToFirestore() {
        // Initialize Firebase services
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Collect form data for the CV
        const formData = getFormData();
        formData.timestamp = serverTimestamp(); // Assign a server-side timestamp for sorting purposes

        // Get the currently logged-in user
        const user = auth.currentUser;

        // If no user is logged in, alert the user and exit the function
        if (!user) {
          alert("You need to be logged in to save your CV.");
          return;
        }

        // Include the currently selected template name in the formData object
        const templateName = getCurrentTemplateName(); // Get the current template name from the UI
        formData.templateName = templateName; // Add the template name to the formData object

        // Attempt to save the CV data to Firestore
        try {
          // Use Firestore's addDoc function to save the formData to the 'cvs' collection
          await addDoc(collection(db, "cvs"), {
            ...formData,
            uid: user.uid, // Include the user's UID for user-specific data storage
          });
          // Alert the user that the CV was saved successfully
          alert("CV saved successfully.");
          // After saving, refresh the list of CVs to include the newly saved CV
          await fetchAndDisplayUserCVs(); // Call the function to fetch and display the user's CVs
        } catch (error) {
          // If an error occurs during saving, log the error and alert the user
          console.error("Error saving CV:", error);
          alert("Failed to save CV. Please try again.");
        }
      }

      // Retrieves the 'Save CV' button and attaches a click event listener to trigger CV saving
      const saveCVButton = document.getElementById("save-cv");
      if (saveCVButton) {
        saveCVButton.addEventListener("click", async () => {
          await saveCVToFirestore(); // Calls the function to save CV data to Firestore
        });
      } else {
        console.error("Save CV button not found"); // Error logged if the button isn't found
      }

      // Retrieves the 'Sign Out' button and adds a click listener for sign out functionality
      const signOutButton = document.getElementById("signOutButton");
      if (signOutButton) {
        signOutButton.addEventListener("click", signOut); // Triggers sign out when clicked
      }

      // Event listener for the photo upload button
      uploadPhotoButton.addEventListener("click", async () => {
        // Checks if a file is selected for upload
        if (cvPhotoInput.files.length > 0) {
          const file = cvPhotoInput.files[0]; // Retrieves the first selected file

          // Calls resizeImage function to resize the selected image before upload
          resizeImage(file, 197, 197, async (blob, dataUrl) => {
            // Creates a reference in Firebase storage for the upload
            const storageRef = ref(storage, `photo_upload/${file.name}`);

            try {
              // Uploads the resized image blob to Firebase Storage
              const uploadTaskSnapshot = await uploadBytes(storageRef, blob);
              // Retrieves the download URL of the uploaded file
              const downloadURL = await getDownloadURL(
                uploadTaskSnapshot.ref
              );

              console.log("File available at", downloadURL); // Logs the download URL
              // Updates the CV photo preview elements with the resized image
              document.getElementById("cv-photo-modern").src = dataUrl;
              document.getElementById("cv-photo-minimalistic").src = dataUrl;
              document.getElementById("cv-photo-professional").src = dataUrl;

              alert("Photo uploaded successfully!"); // Notifies the user of successful upload

              // Updates the upload button text to reflect that a photo has been uploaded
              uploadPhotoButton.textContent = "Replace Photo";
            } catch (error) {
              // Handles and logs any errors during the upload process
              console.error("Upload error:", error);
              alert("Failed to upload photo."); // Notifies the user of an upload failure
            }
          });
        } else {
          // Logs an error and alerts the user if no file is selected for upload
          console.error("No file selected for upload.");
          alert("Please select a file to upload.");
        }
      });

      document
        .getElementById("remove-photo")
        .addEventListener("click", function () {
          // Reset the photo to a default image or set it to an empty string
          document.getElementById("cv-photo-modern").src =
            "path-to-default-photo.jpg";
          document.getElementById("cv-photo-minimalistic").src =
            "path-to-default-photo.jpg";
          document.getElementById("cv-photo-professional").src =
            "path-to-default-photo.jpg";

          // Update the upload button text back to "Upload Photo"
          document.getElementById("upload-photo").textContent =
            "Upload Photo";

          // Clear the file input if you want to reset it as well
          document.getElementById("cv-photo").value = "";

          // Notify the user that the photo has been removed
          alert("Photo removed successfully!");
        });
    }
  </script>
  <!-- jsPDF Library -->
  <!-- This library enables the generation of PDF documents directly in the browser using JavaScript -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
  <!-- html2canvas Library -->
  <!-- Utilized for converting HTML elements into canvas images -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.2/html2canvas.min.js"></script>
  <!-- flatpickr Library -->
  <!-- A lightweight, powerful library for date and time picking. -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <script src="./javascript.js"></script>
</body>

</html>